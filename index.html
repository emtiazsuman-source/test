// Event listener for the "Apply Filter" button
applyFilterBtn.addEventListener('click', async () => {
    if (!uploadedImageBase64) {
        showMessage('একটি ছবি আপলোড করুন', 'error');
        return;
    }

    if (!selectedFilter) {
        showMessage('একটি ফিল্টার নির্বাচন করুন', 'error');
        return;
    }

    loadingOverlay.classList.remove('hidden');
    messageBox.classList.add('hidden');
    isProcessing = true;
    applyFilterBtn.disabled = true;

    const selectedFilterObject = filters.find(f => f.name === selectedFilter);
    const userPrompt = selectedFilterObject.prompt;

    const payload = {
        prompt: userPrompt,
        imageData: uploadedImageBase64
    };

    let retries = 0;
    const maxRetries = 3;
    let success = false;
    let lastError = null;
    
    // Use the API route you created on Vercel
    const apiUrl = '/api/filter'; 

    while (retries < maxRetries && !success) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API error: ${response.statusText} - ${errorData.error.message}`);
            }

            const result = await response.json();
            const base64Data = result.base64Data; // Get the base64 data from the serverless function response

            if (!base64Data) {
                throw new Error('No image was received from the API.');
            }

            addHistory(base64Data);
            updateImage(base64Data);
            showMessage('ফিল্টার সফলভাবে প্রয়োগ করা হয়েছে!', 'success');
            success = true;

        } catch (error) {
            console.error('Error applying filter:', error);
            lastError = error;
            retries++;
            await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
        }
    }
    
    if (!success) {
        showMessage(`ফিল্টার প্রয়োগে ব্যর্থতা: ${lastError.message}`, 'error');
    }

    loadingOverlay.classList.add('hidden');
    isProcessing = false;
    applyFilterBtn.disabled = false;
});
