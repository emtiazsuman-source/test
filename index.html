<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI চালিত কুইজ অ্যাপ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Hind Siliguri', sans-serif;
        }
        /* Simple animation for loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* Custom styles for radio buttons */
        .custom-radio {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #4f46e5;
            border-radius: 50%;
            outline: none;
            transition: 0.2s;
            cursor: pointer;
        }
        .custom-radio:checked {
            background-color: #4f46e5;
            border: 4px solid white;
            box-shadow: 0 0 0 2px #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">
        
        <!-- Initial View: Topic Selection -->
        <div id="topic-selection-view">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">AI কুইজ জেনারেটর</h1>
            <p class="text-center text-gray-500 mb-8">আপনার পছন্দের যেকোনো বিষয় ও ধরণ বাছাই করে কুইজ শুরু করুন!</p>
            <div class="space-y-4">
                <div>
                    <label for="topic-input" class="block text-sm font-medium text-gray-700 mb-1">বিষয় লিখুন</label>
                    <input type="text" id="topic-input" placeholder="যেমন: বাংলাদেশ, ক্রিকেট, বিজ্ঞান..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <div>
                    <label for="level-select" class="block text-sm font-medium text-gray-700 mb-1">প্রশ্নের ধরণ বাছাই করুন</label>
                    <select id="level-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition bg-white">
                        <option value="সহজ">সহজ (Basic)</option>
                        <option value="মধ্যম">মধ্যম (Intermediate)</option>
                        <option value="কঠিন">কঠিন (Hard)</option>
                        <option value="বিসিএস প্রস্তুতি">বিসিএস প্রস্তুতি (BCS Prep)</option>
                        <option value="custom">অন্যান্য (Custom)</option>
                    </select>
                </div>
                <div id="custom-level-container" class="hidden">
                    <label for="custom-level-input" class="block text-sm font-medium text-gray-700 mb-1">আপনার পছন্দের ধরণ লিখুন</label>
                    <input type="text" id="custom-level-input" placeholder="যেমন: ব্যাংক জব, মেডিকেল ভর্তি..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                </div>
                <button id="start-quiz-btn" class="w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                    কুইজ শুরু করুন
                </button>
            </div>
        </div>

        <!-- Quiz View: Question and Options -->
        <div id="quiz-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button id="home-btn" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition">হোম</button>
                <h2 class="text-xl font-bold text-indigo-600 bg-indigo-100 px-4 py-1 rounded-full" id="quiz-topic"></h2>
                <div class="text-lg font-semibold text-gray-700">স্কোর: <span id="score">0/0</span></div>
            </div>

            <!-- Loading Spinner -->
            <div id="loader" class="flex justify-center items-center my-16 hidden">
                <div class="spinner"></div>
            </div>

            <!-- Quiz Content -->
            <div id="quiz-content">
                <p id="question" class="text-2xl font-semibold text-gray-800 mb-8"></p>
                <div id="options" class="space-y-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
            </div>
            
            <div class="mt-8 text-center">
                 <button id="next-question-btn" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 hidden">
                    পরবর্তী প্রশ্ন
                </button>
            </div>
        </div>

        <!-- Error Message Box -->
        <div id="error-box" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
            <strong class="font-bold">ত্রুটি!</strong>
            <span class="block sm-inline" id="error-message"></span>
        </div>

    </div>

    <script>
        // DOM Elements
        const topicSelectionView = document.getElementById('topic-selection-view');
        const quizView = document.getElementById('quiz-view');
        const topicInput = document.getElementById('topic-input');
        const levelSelect = document.getElementById('level-select');
        const customLevelContainer = document.getElementById('custom-level-container');
        const customLevelInput = document.getElementById('custom-level-input');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizTopic = document.getElementById('quiz-topic');
        const scoreEl = document.getElementById('score');
        const loader = document.getElementById('loader');
        const quizContent = document.getElementById('quiz-content');
        const questionEl = document.getElementById('question');
        const optionsEl = document.getElementById('options');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const homeBtn = document.getElementById('home-btn');

        // App State
        let currentTopic = '';
        let currentLevel = '';
        let score = 0;
        let correctAnswer = '';
        let isAnswerSubmitted = false;
        let askedQuestions = [];

        // Event Listeners
        startQuizBtn.addEventListener('click', startQuiz);
        nextQuestionBtn.addEventListener('click', fetchNewQuestion);
        homeBtn.addEventListener('click', goToHome);
        levelSelect.addEventListener('change', () => {
            if (levelSelect.value === 'custom') {
                customLevelContainer.classList.remove('hidden');
            } else {
                customLevelContainer.classList.add('hidden');
            }
        });

        function startQuiz() {
            currentTopic = topicInput.value.trim();
            if (!currentTopic) {
                showError("অনুগ্রহ করে একটি বিষয় লিখুন।");
                return;
            }

            if (levelSelect.value === 'custom') {
                currentLevel = customLevelInput.value.trim();
                if (!currentLevel) {
                    showError("অনুগ্রহ করে আপনার পছন্দের ধরণ লিখুন।");
                    return;
                }
            } else {
                currentLevel = levelSelect.value;
            }
            
            hideError();
            topicSelectionView.classList.add('hidden');
            quizView.classList.remove('hidden');
            quizTopic.textContent = `${currentTopic} (${currentLevel})`;
            score = 0;
            askedQuestions = [];
            updateScore();
            fetchNewQuestion();
        }

        function goToHome() {
            quizView.classList.add('hidden');
            topicSelectionView.classList.remove('hidden');
            topicInput.value = '';
            customLevelInput.value = '';
            levelSelect.selectedIndex = 0;
            customLevelContainer.classList.add('hidden');
            hideError();
        }

        async function fetchNewQuestion() {
            showLoader(true);
            isAnswerSubmitted = false;
            nextQuestionBtn.classList.add('hidden');
            
            optionsEl.innerHTML = '';
            questionEl.textContent = '';

            try {
                // The URL now points to our own serverless function on Vercel
                const vercelApiUrl = '/api/generate-quiz';
                
                const response = await fetch(vercelApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // We send the topic, level, and history to our backend function
                    body: JSON.stringify({ 
                        topic: currentTopic, 
                        level: currentLevel,
                        history: askedQuestions 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `সার্ভার থেকে উত্তর পেতে সমস্যা হচ্ছে।`);
                }

                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0] || !result.candidates[0].content || !result.candidates[0].content.parts || !result.candidates[0].content.parts[0]) {
                    throw new Error("AI থেকে একটি অপ্রত্যাশিত উত্তর এসেছে।");
                }

                let quizDataText = result.candidates[0].content.parts[0].text;
                
                if (quizDataText.startsWith("```json")) {
                    quizDataText = quizDataText.substring(7, quizDataText.length - 3).trim();
                } else if (quizDataText.startsWith("```")) {
                    quizDataText = quizDataText.substring(3, quizDataText.length - 3).trim();
                }

                let parsedData;
                try {
                    parsedData = JSON.parse(quizDataText);
                } catch (parseError) {
                    throw new Error("AI একটি ভুল ফরম্যাটে ডেটা পাঠিয়েছে।");
                }
                
                const quizObject = Array.isArray(parsedData) ? parsedData[0] : parsedData;

                if (!quizObject || !quizObject.question || !quizObject.options || !Array.isArray(quizObject.options) || !quizObject.correct_answer) {
                    throw new Error("AI থেকে পাওয়া ডেটা সঠিক ফরম্যাটে নেই।");
                }
                
                displayQuestion(quizObject);
                hideError();

            } catch (error) {
                console.error('Error fetching quiz question:', error);
                showError(`প্রশ্ন আনতে সমস্যা হচ্ছে। ${error.message}`);
            } finally {
                showLoader(false);
            }
        }
        
        function displayQuestion(data) {
            questionEl.textContent = data.question;
            correctAnswer = data.correct_answer;
            
            askedQuestions.push(data.question);
            updateScore();

            const shuffledOptions = data.options.sort(() => Math.random() - 0.5);

            shuffledOptions.forEach((option, index) => {
                const optionId = `option${index}`;
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('border', 'border-gray-200', 'rounded-lg', 'p-4', 'hover:bg-indigo-50', 'transition', 'cursor-pointer');
                optionDiv.innerHTML = `
                    <input type="radio" name="option" value="${option}" id="${optionId}" class="custom-radio">
                    <label for="${optionId}" class="ml-3 text-lg text-gray-700 cursor-pointer">${option}</label>
                `;
                optionDiv.addEventListener('click', () => {
                    if (isAnswerSubmitted) return;
                    document.getElementById(optionId).checked = true;
                    checkAnswer();
                });
                optionsEl.appendChild(optionDiv);
            });
        }

        function checkAnswer() {
            const selectedOption = document.querySelector('input[name="option"]:checked');
            if (!selectedOption) return;
            
            isAnswerSubmitted = true;
            
            const userAnswer = selectedOption.value;
            const allOptionDivs = optionsEl.querySelectorAll('div');

            allOptionDivs.forEach(div => {
                const input = div.querySelector('input');
                div.classList.remove('hover:bg-indigo-50');
                div.style.cursor = 'default';

                if (input.value === correctAnswer) {
                    div.classList.add('bg-green-100', 'border-green-500');
                } else if (input.checked) {
                    div.classList.add('bg-red-100', 'border-red-500');
                }
            });

            if (userAnswer === correctAnswer) {
                score++;
                updateScore();
            }
            
            nextQuestionBtn.classList.remove('hidden');
        }

        function updateScore() {
            scoreEl.innerHTML = `<span class="text-green-600 font-bold">${score}</span><span class="text-gray-500">/${askedQuestions.length}</span>`;
        }

        function showLoader(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                quizContent.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                quizContent.classList.remove('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }
    </script>
</body>
</html>
