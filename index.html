<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>শ্রমিক বাজার</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for truncation */
        .truncate-1-line {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Ensure modals are scrollable on smaller screens */
        .modal-scroll-y {
            overflow-y: auto;
            max-height: 90vh; /* Set a max-height for scrollable modals */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in browser (for development/single file) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, startAfter, serverTimestamp, doc, setDoc, getDoc, deleteDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        window.firebaseApp = null;
        window.authInstance = null;
        window.firestoreInstance = null;

        // Firebase configuration (replace with your actual config if different)
        const firebaseConfig = {
            apiKey: "AIzaSyAenBUkz8Ynac4jMttAxOhOGcGL6NiUZtQ",
            authDomain: "malik-sromik.firebaseapp.com",
            projectId: "malik-sromik",
            storageBucket: "malik-sromik.firebasestorage.app",
            messagingSenderId: "484276776897",
            appId: "1:484277776897:web:4e537355368a98b1124940", // Changed to avoid collision if default-app-id is used
            measurementId: "G-JY1Q35GER2"
        };

        // Canvas environment specific app ID for Firestore collection paths
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.canvasAppId = canvasAppId; // Make it globally accessible

        // Initialize Firebase
        window.firebaseApp = initializeApp(firebaseConfig);
        window.authInstance = getAuth(window.firebaseApp);
        window.firestoreInstance = getFirestore(window.firebaseApp);

        // Make Firebase functions globally accessible for the React code
        window.getAuth = getAuth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;

        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;
        window.startAfter = startAfter;
        window.serverTimestamp = serverTimestamp;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.deleteDoc = deleteDoc; // Add deleteDoc
        window.updateDoc = updateDoc; // Add updateDoc
        window.where = where; // Add where for queries
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const ReactDOM = ReactDOM; // Ensure ReactDOM is available

        // Data for Divisions and Districts of Bangladesh
        const DIVISIONS_DATA = {
            "ঢাকা": ["ঢাকা", "গাজীপুর", "ফরিদপুর", "গোপালগঞ্জ", "কিশোরগঞ্জ", "মাদারীপুর", "মানিকগঞ্জ", "মুন্সিগঞ্জ", "নারায়ণগঞ্জ", "নরসিংদী", "রাজবাড়ী", "শরীয়তপুর", "টাঙ্গাইল"],
            "চট্টগ্রাম": ["চট্টগ্রাম", "বান্দরবান", "ব্রাহ্মণবাড়িয়া", "চাঁদপুর", "কুমিল্লা", "কক্সবাজার", "ফেনী", "খাগড়াছড়ি", "লক্ষ্মীপুর", "নোয়াখালী", "রাঙ্গামাটি"],
            "রাজশাহী": ["রাজশাহী", "বগুড়া", "জয়পুরহাট", "নওগাঁ", "নাটোর", "চাঁপাইনবাবগঞ্জ", "পাবনা", "সিরাজগঞ্জ"],
            "খুলনা": ["খুলনা", "বাগেরহাট", "চুয়াডাঙ্গা", "যশোর", "ঝিনাইদহ", "কুষ্টিয়া", "মাগুরা", "মেহেরপুর", "নড়াইল", "সাতক্ষীরা"],
            "বরিশাল": ["বরিশাল", "ভোলা", "ঝালকাঠি", "বরগুনা", "পটুয়াখালী", "পিরোজপুর"],
            "সিলেট": ["সিলেট", "হবিগঞ্জ", "মৌলভীবাজার", "সুনামগঞ্জ"],
            "রংপুর": ["রংপুর", "দিনাজপুর", "গাইবান্ধা", "কুড়িগ্রাম", "লালমনিরহাট", "নীলফামারী", "পঞ্চগড়", "ঠাকুরগাঁও"],
            "ময়মনসিংহ": ["ময়মনসিংহ", "জামালপুর", "নেত্রকোণা", "শেরপুর"]
        };

        /**
         * Helper function to format time elapsed since a given timestamp.
         * @param {Object} timestamp - Firestore Timestamp object.
         * @returns {string} - Formatted string like "5 মিনিট আগে", "2 ঘণ্টা আগে", "3 দিন আগে".
         */
        const formatTimeAgo = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return '';
            const now = new Date();
            const postDate = timestamp.toDate();
            const diffMs = now.getTime() - postDate.getTime(); // Difference in milliseconds

            const diffMinutes = Math.round(diffMs / (1000 * 60));
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

            if (diffMinutes < 1) {
                return "এইমাত্র";
            } else if (diffMinutes < 60) {
                return `${diffMinutes} মিনিট আগে`;
            } else if (diffHours < 24) {
                const remainingMinutes = diffMinutes % 60;
                if (remainingMinutes > 0) {
                    return `${diffHours} ঘণ্টা ${remainingMinutes} মিনিট আগে`;
                }
                return `${diffHours} ঘণ্টা আগে`;
            } else {
                return `${diffDays} দিন আগে`;
            }
        };

        /**
         * AuthForm component for handling user login and signup.
         * It's a modal form that toggles between login and signup modes.
         */
        function AuthForm({ mode, onClose, onToggleMode, authInstance, onAuthSuccess }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState(''); // New state for full name
            const [authError, setAuthError] = useState(null);
            const [isAuthenticating, setIsAuthenticating] = useState(false);

            // Handles either login or signup based on the current mode
            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError(null); // Clear previous errors
                setIsAuthenticating(true); // Set authenticating state

                try {
                    if (mode === 'login') {
                        // Sign in existing user
                        const userCredential = await window.signInWithEmailAndPassword(authInstance, email, password);
                        onAuthSuccess(userCredential.user, null); // No full name for login
                    } else { // signup
                        // Validate full name for signup
                        if (!fullName.trim()) {
                            setAuthError("অনুগ্রহ করে আপনার সম্পূর্ণ নাম লিখুন।");
                            return;
                        }
                        // Create new user
                        const userCredential = await window.createUserWithEmailAndPassword(authInstance, email, password);
                        onAuthSuccess(userCredential.user, fullName.trim()); // Pass full name for signup
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    let errorMessage = "প্রমাণীকরণে সমস্যা হয়েছে।"; // Default error message

                    // Provide more specific error messages based on Firebase error codes
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = "অকার্যকর ইমেল ঠিকানা।";
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = "এই ব্যবহারকারী নিষ্ক্রিয় করা হয়েছে।";
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        errorMessage = "ভুল ইমেল বা পাসওয়ার্ড।";
                    } else if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "এই ইমেল ঠিকানাটি ইতিমধ্যেই ব্যবহৃত হচ্ছে।";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "পাসওয়ার্ডটি খুব দুর্বল। কমপক্ষে 6 অক্ষর ব্যবহার করুন।";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = "ইমেল/পাসওয়ার্ড লগইন সক্ষম করা হয়নি।";
                    }
                    setAuthError(errorMessage); // Display the error message to the user
                } finally {
                    setIsAuthenticating(false); // Reset authenticating state
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 modal-scroll-y">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100 my-8">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">{mode === 'login' ? 'লগইন করুন' : 'সাইনআপ করুন'}</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1 transition duration-150 ease-in-out"
                                aria-label="ফর্ম বন্ধ করুন"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        {/* Display authentication error messages */}
                        {authError && (
                            <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                                {authError}
                            </div>
                        )}

                        <form onSubmit={handleAuth} className="space-y-4">
                            {mode === 'signup' && (
                                <div>
                                    <label htmlFor="fullName" className="block text-sm font-medium text-gray-700 mb-1">সম্পূর্ণ নাম <span className="text-red-500">*</span></label>
                                    <input
                                        type="text"
                                        id="fullName"
                                        value={fullName}
                                        onChange={(e) => setFullName(e.target.value)}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        required={mode === 'signup'}
                                    />
                                </div>
                            )}
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">ইমেল</label>
                                <input
                                    type="email"
                                    id="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">পাসওয়ার্ড</label>
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    required
                                />
                            </div>

                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="submit"
                                    className="inline-flex justify-center py-2 px-5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                                    disabled={isAuthenticating} // Disable button during authentication
                                >
                                    {isAuthenticating ? 'প্রমাণীকরণ হচ্ছে...' : (mode === 'login' ? 'লগইন করুন' : 'সাইনআপ করুন')}
                                </button>
                            </div>
                        </form>

                        <p className="mt-4 text-center text-sm text-gray-600">
                            {mode === 'login' ? "আপনার কি অ্যাকাউন্ট নেই?" : "আপনার কি ইতিমধ্যেই একটি অ্যাকাউন্ট আছে?"}{' '}
                            <button
                                onClick={onToggleMode} // Toggle between login and signup modes
                                className="font-medium text-blue-600 hover:text-blue-500 focus:outline-none focus:underline"
                            >
                                {mode === 'login' ? 'সাইনআপ করুন' : 'লগইন করুন'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        /**
         * PostJobForm component for adding new job postings or job seeker profiles.
         * It's a modal form that allows users to select between posting a job or a job seeker profile.
         * Added initialData prop for editing existing posts.
         */
        function PostJobForm({ onClose, onAddJob, initialData = null, onUpdateJob, jobCategories }) { // Added jobCategories prop
            const [postType, setPostType] = useState(initialData ? initialData.postType : 'job_receiver'); // 'job_receiver' for job seeker profile, 'job_sender' for job posting

            // Common fields for Job Sender and Job Receiver
            const [selectedDivision, setSelectedDivision] = useState(initialData ? initialData.division : '');
            const [selectedDistrict, setSelectedDistrict] = useState(initialData ? initialData.district : '');
            const [selectedJobCategory, setSelectedJobCategory] = useState(initialData ? initialData.jobCategory : ''); // State for job category
            const [mobileNumber, setMobileNumber] = useState(initialData ? initialData.mobileNumber : ''); // New state for mobile number

            // State for Job Sender fields
            const [jobTitle, setJobTitle] = useState(initialData && initialData.postType === 'job_sender' ? initialData.jobTitle : '');
            // Changed from company to numWorkersNeeded
            const [numWorkersNeeded, setNumWorkersNeeded] = useState(initialData && initialData.postType === 'job_sender' ? initialData.numWorkersNeeded : '');
            const [description, setDescription] = useState(initialData && initialData.postType === 'job_sender' ? initialData.description : '');
            const [salary, setSalary] = useState(initialData && initialData.postType === 'job_sender' ? initialData.salary : '');

            // State for Job Receiver fields
            const [desiredJobTitle, setDesiredJobTitle] = useState(initialData && initialData.postType === 'job_receiver' ? initialData.desiredJobTitle : '');
            // New field: numTeamMembers
            const [numTeamMembers, setNumTeamMembers] = useState(initialData && initialData.postType === 'job_receiver' ? initialData.numTeamMembers : '');
            const [expectedSalary, setExpectedSalary] = useState(initialData && initialData.postType === 'job_receiver' ? initialData.expectedSalary : '');
            const [bioSummary, setBioSummary] = useState(initialData && initialData.postType === 'job_receiver' ? initialData.bioSummary : '');

            const [isSubmitting, setIsSubmitting] = useState(false);
            const [formError, setFormError] = useState(null);
            const [showConfirmation, setShowConfirmation] = useState(false);

            // Get districts based on the selected division
            const districtsForSelectedDivision = selectedDivision ? DIVISIONS_DATA[selectedDivision] : [];

            // Reset district when division changes
            useEffect(() => {
                setSelectedDistrict('');
            }, [selectedDivision]);

            // Handle form submission
            const handleSubmit = async (e) => {
                e.preventDefault();
                setFormError(null); // Clear previous errors

                let jobData = { postType }; // Initialize jobData with postType

                // Basic validation for division, district, and job category (common for both types)
                if (!selectedDivision || !selectedDistrict || !selectedJobCategory) {
                    setFormError("অনুগ্রহ করে বিভাগ, জেলা এবং কাজের ধরণ নির্বাচন করুন।");
                    return;
                }

                // Validate and collect data based on the selected post type
                if (postType === 'job_sender') {
                    // Required fields for job posting
                    // Changed validation from company to numWorkersNeeded
                    if (!jobTitle || !numWorkersNeeded || !description || !mobileNumber) { // mobileNumber is now required
                        setFormError("অনুগ্রহ করে সমস্ত প্রয়োজনীয় ক্ষেত্র পূরণ করুন (চাকরি পোস্ট)।");
                        return;
                    }
                    jobData = {
                        ...jobData,
                        jobTitle,
                        numWorkersNeeded, // Changed from company
                        description,
                        salary,
                        division: selectedDivision,
                        district: selectedDistrict,
                        jobCategory: selectedJobCategory, // Add job category
                        mobileNumber // Include mobile number
                    };
                } else { // job_receiver
                    // Updated validation for job_receiver
                    if (!desiredJobTitle || !numTeamMembers || !mobileNumber) { // mobileNumber is now required
                        setFormError("অনুগ্রহ করে সমস্ত প্রয়োজনীয় ক্ষেত্র পূরণ করুন (চাকরি খুঁজছি)।");
                        return;
                    }
                    jobData = {
                        ...jobData,
                        desiredJobTitle,
                        numTeamMembers, // New field
                        expectedSalary,
                        bioSummary,
                        division: selectedDivision,
                        district: selectedDistrict,
                        jobCategory: selectedJobCategory, // Add job category
                        mobileNumber // Include mobile number
                    };
                }

                setIsSubmitting(true); // Set submitting state to true
                try {
                    if (initialData) {
                        // If initialData is provided, it's an update operation
                        // Set status to 'pending' when a post is edited
                        await onUpdateJob(initialData.id, { ...jobData, status: 'pending' });
                    } else {
                        // Otherwise, it's an add operation
                        // New posts start with 'pending' status
                        await onAddJob({ ...jobData, status: 'pending' });
                    }
                    setShowConfirmation(true); // Show confirmation message
                    // Automatically close the form after a short delay
                    setTimeout(() => {
                        setShowConfirmation(false);
                        onClose();
                    }, 1500);
                } catch (e) {
                    setFormError("পোস্ট করতে সমস্যা হয়েছে: " + e.message); // Display error message
                    console.error("Error submitting post:", e);
                } finally {
                    setIsSubmitting(false); // Reset submitting state
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all duration-300 scale-100 opacity-100 modal-scroll-y">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">{initialData ? 'পোস্ট সম্পাদনা করুন' : 'নতুন পোস্ট করুন'}</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1 transition duration-150 ease-in-out"
                                aria-label="ফর্ম বন্ধ করুন"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        {/* Error message display */}
                        {formError && (
                            <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                                {formError}
                            </div>
                        )}

                        {/* Confirmation message display */}
                        {showConfirmation && (
                            <div className="bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-sm">
                                পোস্ট সফলভাবে সম্পন্ন হয়েছে!
                            </div>
                        )}

                        {/* Post Type Selection */}
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">আপনি কী পোস্ট করতে চান?</label>
                            <div className="flex gap-4">
                                <label className="inline-flex items-center">
                                    <input
                                        type="radio"
                                        className="form-radio text-blue-600"
                                        name="postType"
                                        value="job_receiver"
                                        checked={postType === 'job_receiver'}
                                        onChange={() => setPostType('job_receiver')}
                                        disabled={!!initialData} // Disable changing type when editing
                                    />
                                    <span className="ml-2 text-gray-700">শ্রমিক</span>
                                </label>
                                <label className="inline-flex items-center">
                                    <input
                                        type="radio"
                                        className="form-radio text-blue-600"
                                        name="postType"
                                        value="job_sender"
                                        checked={postType === 'job_sender'}
                                        onChange={() => setPostType('job_sender')}
                                        disabled={!!initialData} // Disable changing type when editing
                                    />
                                    <span className="ml-2 text-gray-700">মালিক</span>
                                </label>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* Division Selection (Common for both types) */}
                            <div>
                                <label htmlFor="division" className="block text-sm font-medium text-gray-700 mb-1">বিভাগ <span className="text-red-500">*</span></label>
                                <select
                                    id="division"
                                    value={selectedDivision}
                                    onChange={(e) => setSelectedDivision(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    required
                                >
                                    <option value="">একটি বিভাগ নির্বাচন করুন</option>
                                    {Object.keys(DIVISIONS_DATA).map((division) => (
                                        <option key={division} value={division}>{division}</option>
                                    ))}
                                </select>
                            </div>

                            {/* District Selection (Common for both types) */}
                            <div>
                                <label htmlFor="district" className="block text-sm font-medium text-gray-700 mb-1">জেলা <span className="text-red-500">*</span></label>
                                <select
                                    id="district"
                                    value={selectedDistrict}
                                    onChange={(e) => setSelectedDistrict(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    required
                                    disabled={!selectedDivision} // Disable district selection until a division is chosen
                                >
                                    <option value="">একটি জেলা নির্বাচন করুন</option>
                                    {districtsForSelectedDivision.map((district) => (
                                        <option key={district} value={district}>{district}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Job Category Selection (Common for both types) */}
                            <div>
                                <label htmlFor="jobCategory" className="block text-sm font-medium text-gray-700 mb-1">কাজের ধরণ <span className="text-red-500">*</span></label>
                                <select
                                    id="jobCategory"
                                    value={selectedJobCategory}
                                    onChange={(e) => setSelectedJobCategory(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    required
                                >
                                    <option value="">একটি কাজের ধরণ নির্বাচন করুন</option>
                                    {jobCategories.map((category) => (
                                        <option key={category.id} value={category.name}>{category.name}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Mobile Number Field (Common for both types) */}
                            <div>
                                <label htmlFor="mobileNumber" className="block text-sm font-medium text-gray-700 mb-1">মোবাইল নম্বর <span className="text-red-500">*</span></label>
                                <input
                                    type="tel" // Use type="tel" for phone numbers
                                    id="mobileNumber"
                                    value={mobileNumber}
                                    onChange={(e) => setMobileNumber(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    required // Made required
                                />
                            </div>

                            {postType === 'job_sender' ? (
                                <>
                                    {/* Job Sender Fields */}
                                    <div>
                                        <label htmlFor="jobTitle" className="block text-sm font-medium text-gray-700 mb-1">চাকরির শিরোনাম <span className="text-red-500">*</span></label>
                                        <input
                                            type="text"
                                            id="jobTitle"
                                            value={jobTitle}
                                            onChange={(e) => setJobTitle(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            required
                                        />
                                    </div>
                                    {/* Changed from Company Name to Number of Workers Needed */}
                                    <div>
                                        <label htmlFor="numWorkersNeeded" className="block text-sm font-medium text-gray-700 mb-1">আপনার কতজন শ্রমিক প্রয়োজন? <span className="text-red-500">*</span></label>
                                        <input
                                            type="number"
                                            id="numWorkersNeeded"
                                            value={numWorkersNeeded}
                                            onChange={(e) => setNumWorkersNeeded(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            required
                                            min="1" // Ensure at least 1 worker is needed
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">বর্ণনা <span className="text-red-500">*</span></label>
                                        <textarea
                                            id="description"
                                            value={description}
                                            onChange={(e) => setDescription(e.target.value)}
                                            rows="4"
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            required
                                        ></textarea>
                                    </div>
                                    <div>
                                        <label htmlFor="salary" className="block text-sm font-medium text-gray-700 mb-1">বেতন (ঐচ্ছিক)</label>
                                        <input
                                            type="number"
                                            id="salary"
                                            value={salary}
                                            onChange={(e) => setSalary(e.target.value === '' ? '' : Number(e.target.value))}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            min="0"
                                        />
                                    </div>
                                </>
                            ) : (
                                <>
                                    {/* Job Receiver Fields */}
                                    <div>
                                        <label htmlFor="desiredJobTitle" className="block text-sm font-medium text-gray-700 mb-1">সংক্ষিপ্ত শিরোনাম <span className="text-red-500">*</span></label> {/* Changed label */}
                                        <input
                                            type="text"
                                            id="desiredJobTitle"
                                            value={desiredJobTitle}
                                            onChange={(e) => setDesiredJobTitle(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            required
                                        />
                                    </div>
                                    {/* New field: Number of Team Members */}
                                    <div>
                                        <label htmlFor="numTeamMembers" className="block text-sm font-medium text-gray-700 mb-1">আপনার দলে কতজন কর্মী আছে? <span className="text-red-500">*</span></label>
                                        <input
                                            type="number"
                                            id="numTeamMembers"
                                            value={numTeamMembers}
                                            onChange={(e) => setNumTeamMembers(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            required
                                            min="0" // Can be 0 if it's an individual
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="expectedSalary" className="block text-sm font-medium text-gray-700 mb-1">প্রত্যাশিত বেতন (ঐচ্ছিক)</label>
                                        <input
                                            type="number"
                                            id="expectedSalary"
                                            value={expectedSalary}
                                            onChange={(e) => setExpectedSalary(e.target.value === '' ? '' : Number(e.target.value))}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            min="0"
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="bioSummary" className="block text-sm font-medium text-gray-700 mb-1">বিস্তারিত (ঐচ্ছিক)</label> {/* Changed label and made optional */}
                                        <textarea
                                            id="bioSummary"
                                            value={bioSummary}
                                            onChange={(e) => setBioSummary(e.target.value)}
                                            rows="4"
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            // Removed required attribute
                                        ></textarea>
                                    </div>
                                </>
                            )}

                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="px-5 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                                    disabled={isSubmitting}
                                >
                                    বাতিল করুন
                                </button>
                                <button
                                    type="submit"
                                    className="inline-flex justify-center py-2 px-5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                                    disabled={isSubmitting}
                                >
                                    {isSubmitting ? 'পোস্ট হচ্ছে...' : (initialData ? 'আপডেট করুন' : 'পোস্ট করুন')}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        /**
         * UserProfileModal component to display user's profile and their posts.
         * Allows users to view, edit, and delete their own posts.
         */
        function UserProfileModal({ onClose, userId, userFullName, db, onEditPost, onDeletePost }) {
            const [userPosts, setUserPosts] = useState([]);
            const [loadingUserPosts, setLoadingUserPosts] = useState(true);
            const [profileError, setProfileError] = useState(null);

            useEffect(() => {
                if (!db || !userId) {
                    setLoadingUserPosts(false);
                    return;
                }

                // Query to fetch posts by the current user
                const userPostsQuery = window.query(
                    window.collection(db, `artifacts/${window.canvasAppId}/public/data/posts`),
                    window.where('postedBy', '==', userId),
                    window.orderBy('timestamp', 'desc')
                );

                const unsubscribe = window.onSnapshot(userPostsQuery, (snapshot) => {
                    const fetchedPosts = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setUserPosts(fetchedPosts);
                    setLoadingUserPosts(false);
                }, (e) => {
                    console.error("Error fetching user posts:", e);
                    setProfileError("আপনার পোস্ট লোড করতে সমস্যা হয়েছে।");
                    setLoadingUserPosts(false);
                });

                return () => unsubscribe(); // Clean up listener
            }, [db, userId]);

            // Handle delete confirmation
            const handleDeleteClick = async (postId) => {
                // In a real application, you'd use a custom modal for confirmation
                if (window.confirm("আপনি কি নিশ্চিত যে আপনি এই পোস্টটি মুছে ফেলতে চান?")) {
                    try {
                        await onDeletePost(postId);
                        // No need to update state here, onSnapshot will handle it
                    } catch (e) {
                        setProfileError("পোস্ট মোছা যায়নি: " + e.message);
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl transform transition-all duration-300 scale-100 opacity-100 my-8">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">আমার প্রোফাইল</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1 transition duration-150 ease-in-out"
                                aria-label="ফর্ম বন্ধ করুন"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        {profileError && (
                            <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                                {profileError}
                            </div>
                        )}

                        <div className="mb-6">
                            <p className="text-lg font-semibold text-gray-700">নাম: {userFullName || "N/A"}</p>
                            <p className="text-sm text-gray-500">ইউজার আইডি: {userId}</p>
                        </div>

                        <h3 className="text-xl font-bold text-gray-800 mb-4">আমার পোস্টসমূহ</h3>
                        {loadingUserPosts ? (
                            <div className="text-center py-4">
                                <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-2"></div>
                                <p className="text-gray-600">পোস্ট লোড হচ্ছে...</p>
                            </div>
                        ) : userPosts.length > 0 ? (
                            <div className="space-y-4">
                                {userPosts.map((post) => (
                                    <div key={post.id} className="bg-gray-50 rounded-lg p-4 shadow-sm border border-gray-200">
                                        {post.postType === 'job_sender' ? (
                                            <>
                                                <h4 className="text-lg font-semibold text-blue-600">{post.jobTitle}</h4>
                                                {/* Display Number of Workers Needed */}
                                                <p className="text-sm text-gray-600">শ্রমিক লাগবে: {post.numWorkersNeeded} জন</p>
                                                <p className="text-sm text-gray-600">বিভাগ: {post.division}, জেলা: {post.district}</p>
                                                <p className="text-sm text-gray-600">কাজের ধরণ: {post.jobCategory}</p>
                                                {post.mobileNumber && <p className="text-sm text-gray-600">মোবাইল নম্বর: {post.mobileNumber}</p>} {/* Display mobile number */}
                                                <p className="text-sm text-gray-700 mt-1">{post.description}</p>
                                                {post.salary && <p className="text-green-600 text-sm">বেতন: {post.salary} টাকা</p>}
                                            </>
                                        ) : (
                                            <>
                                                <h4 className="text-lg font-semibold text-purple-600">চাকরি খুঁজছি: {post.desiredJobTitle}</h4>
                                                <p className="text-sm text-gray-600">কর্মী আছে: {post.numTeamMembers} জন</p>
                                                <p className="text-sm text-gray-600">বিভাগ: {post.division}, জেলা: {post.district}</p>
                                                <p className="text-sm text-gray-600">কাজের ধরণ: {post.jobCategory}</p>
                                                {post.mobileNumber && <p className="text-sm text-gray-600">মোবাইল নম্বর: {post.mobileNumber}</p>} {/* Display mobile number */}
                                                {post.expectedSalary && <p className="text-green-600 text-sm">প্রত্যাশিত বেতন: {post.expectedSalary} টাকা</p>}
                                                <p className="text-sm text-gray-700 mt-1">{post.bioSummary}</p>
                                            </>
                                        )}
                                        <p className="text-xs text-gray-500 mt-3">স্ট্যাটাস: <span className={`font-semibold ${post.status === 'approved' ? 'text-green-500' : post.status === 'pending' ? 'text-yellow-500' : 'text-red-500'}`}>{post.status === 'pending' ? 'পেন্ডিং' : post.status === 'approved' ? 'অনুমোদিত' : 'প্রত্যাখ্যাত'}</span></p>
                                        {post.timestamp && (
                                            <p className="text-xs text-gray-500">
                                                পোস্ট করা হয়েছে: {formatTimeAgo(post.timestamp)}
                                            </p>
                                        )}
                                        <div className="flex justify-end space-x-2 mt-3">
                                            <button
                                                onClick={() => onEditPost(post)}
                                                className="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-150 ease-in-out"
                                            >
                                                সম্পাদনা করুন
                                            </button>
                                            <button
                                                onClick={() => handleDeleteClick(post.id)}
                                                className="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-150 ease-in-out"
                                            >
                                                মুছে ফেলুন
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p className="text-center text-gray-500">আপনার কোনো পোস্ট নেই।</p>
                        )}
                    </div>
                </div>
            );
        }

        /**
         * AdminPanelModal component to display all posts and allow admin to delete them.
         * This is a simplified admin panel for demonstration.
         */
        function AdminPanelModal({ onClose, db, onDeletePost, isAdmin }) {
            const [allPosts, setAllPosts] = useState([]);
            const [loadingAllPosts, setLoadingAllPosts] = useState(true);
            const [adminError, setAdminError] = useState(null);
            const [filterStatus, setFilterStatus] = useState('all'); // 'all', 'pending', 'approved', 'rejected'

            // State for Job Categories management
            const [jobCategories, setJobCategories] = useState([]);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [categoryManagementError, setCategoryManagementError] = useState(null);
            const [isAddingCategory, setIsAddingCategory] = useState(false);

            // Fetch all posts for admin view
            useEffect(() => {
                if (!db || !isAdmin) { // Only fetch if user is admin
                    setLoadingAllPosts(false);
                    return;
                }

                const postsCollectionRef = window.collection(db, `artifacts/${window.canvasAppId}/public/data/posts`);
                let q = window.query(postsCollectionRef, window.orderBy('timestamp', 'desc'));

                if (filterStatus !== 'all') {
                    q = window.query(postsCollectionRef, window.where('status', '==', filterStatus), window.orderBy('timestamp', 'desc'));
                }

                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const fetchedPosts = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setAllPosts(fetchedPosts);
                    setLoadingAllPosts(false);
                }, (e) => {
                    console.error("Error fetching all posts for admin:", e);
                    setAdminError("সমস্ত পোস্ট লোড করতে সমস্যা হয়েছে।");
                    setLoadingAllPosts(false);
                });

                return () => unsubscribe();
            }, [db, isAdmin, filterStatus]);

            // Fetch job categories for admin management
            useEffect(() => {
                if (!db || !isAdmin) {
                    setJobCategories([]);
                    return;
                }

                const categoriesCollectionRef = window.collection(db, `artifacts/${window.canvasAppId}/public/data/jobCategories`);
                const q = window.query(categoriesCollectionRef, window.orderBy('name', 'asc'));

                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const fetchedCategories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setJobCategories(fetchedCategories);
                }, (e) => {
                    console.error("Error fetching job categories for admin:", e);
                    setCategoryManagementError("কাজের ধরণ লোড করতে সমস্যা হয়েছে।");
                });

                return () => unsubscribe();
            }, [db, isAdmin]);

            // Function to add a new category
            const handleAddCategory = async () => {
                if (!db || !isAdmin) {
                    setCategoryManagementError("আপনার এই কাজটি করার অনুমতি নেই।");
                    return;
                }
                if (!newCategoryName.trim()) {
                    setCategoryManagementError("কাজের ধরণ খালি রাখা যাবে না।");
                    return;
                }
                if (jobCategories.some(cat => cat.name.toLowerCase() === newCategoryName.trim().toLowerCase())) {
                    setCategoryManagementError("এই কাজের ধরণটি ইতিমধ্যেই বিদ্যমান।");
                    return;
                }

                setIsAddingCategory(true);
                setCategoryManagementError(null);
                try {
                    await window.addDoc(window.collection(db, `artifacts/${window.canvasAppId}/public/data/jobCategories`), {
                        name: newCategoryName.trim(),
                        timestamp: window.serverTimestamp()
                    });
                    setNewCategoryName('');
                    console.log("Category added successfully!");
                } catch (e) {
                    console.error("Error adding category:", e);
                    setCategoryManagementError("কাজের ধরণ যোগ করতে সমস্যা হয়েছে: " + e.message);
                } finally {
                    setIsAddingCategory(false);
                }
            };

            // Function to delete a category
            const handleDeleteCategory = async (categoryId) => {
                if (!db || !isAdmin) {
                    setCategoryManagementError("আপনার এই কাজটি করার অনুমতি নেই।");
                    return;
                }
                if (window.confirm("আপনি কি নিশ্চিত যে আপনি এই কাজের ধরণটি মুছে ফেলতে চান?")) {
                    setCategoryManagementError(null);
                    try {
                        await window.deleteDoc(window.doc(db, `artifacts/${window.canvasAppId}/public/data/jobCategories`, categoryId));
                        console.log("Category deleted successfully!");
                    } catch (e) {
                        console.error("Error deleting category:", e);
                        setCategoryManagementError("কাজের ধরণ মুছে ফেলতে সমস্যা হয়েছে: " + e.message);
                    }
                }
            };

            // Function to update a post's status
            const updatePostStatus = async (postId, newStatus) => {
                if (!db || !isAdmin) {
                    setAdminError("আপনার এই কাজটি করার অনুমতি নেই।");
                    return;
                }
                try {
                    const postRef = window.doc(db, `artifacts/${window.canvasAppId}/public/data/posts`, postId);
                    await window.updateDoc(postRef, { status: newStatus });
                    console.log(`Post ${postId} status updated to ${newStatus}`);
                } catch (e) {
                    console.error("Error updating post status:", e);
                    setAdminError("পোস্টের স্ট্যাটাস আপডেট করতে সমস্যা হয়েছে: " + e.message);
                }
            };

            // Handle delete confirmation for any post
            const handleDeleteClick = async (postId) => {
                if (window.confirm("আপনি কি নিশ্চিত যে আপনি এই পোস্টটি মুছে ফেলতে চান? (অ্যাডमिन অ্যাকশন)")) {
                    try {
                        await onDeletePost(postId);
                        // onSnapshot will automatically update the list
                    } catch (e) {
                        setAdminError("পোস্ট মোছা যায়নি: " + e.message);
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl transform transition-all duration-300 scale-100 opacity-100 my-8">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">অ্যাডমিন প্যানেল</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1 transition duration-150 ease-in-out"
                                aria-label="অ্যাডমিন প্যানেল বন্ধ করুন"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        {adminError && (
                            <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                                {adminError}
                            </div>
                        )}

                        {/* Content area that needs to scroll */}
                        <div className="overflow-y-auto max-h-[calc(90vh-180px)]"> {/* Adjusted max-height for better fit */}
                            {/* Job Category Management Section */}
                            <div className="mb-8 p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                                <h3 className="text-xl font-bold text-gray-800 mb-4">কাজের ধরণ ব্যবস্থাপনা</h3>
                                {categoryManagementError && (
                                    <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                                        {categoryManagementError}
                                    </div>
                                )}
                                <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                    <input
                                        type="text"
                                        value={newCategoryName}
                                        onChange={(e) => setNewCategoryName(e.target.value)}
                                        placeholder="নতুন কাজের ধরণ যোগ করুন"
                                        className="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    />
                                    <button
                                        onClick={handleAddCategory}
                                        disabled={isAddingCategory || !newCategoryName.trim()}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {isAddingCategory ? 'যোগ হচ্ছে...' : 'যোগ করুন'}
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    {jobCategories.length > 0 ? (
                                        jobCategories.map((category) => (
                                            <div key={category.id} className="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-gray-100">
                                                <span className="text-gray-700 text-sm">{category.name}</span>
                                                <button
                                                    onClick={() => handleDeleteCategory(category.id)}
                                                    className="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-md transition duration-150 ease-in-out"
                                                >
                                                    মুছে ফেলুন
                                                </button>
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-center text-gray-500 col-span-full">কোনো কাজের ধরণ নেই।</p>
                                    )}
                                </div>
                            </div>

                            <h3 className="text-xl font-bold text-gray-800 mb-4">সমস্ত পোস্ট</h3>

                            {/* Filter controls */}
                            <div className="mb-4 flex flex-wrap gap-2 sm:space-x-4">
                                <button
                                    onClick={() => setFilterStatus('all')}
                                    className={`py-2 px-4 rounded-md text-sm font-medium ${filterStatus === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                                >
                                    সব পোস্ট
                                </button>
                                <button
                                    onClick={() => setFilterStatus('pending')}
                                    className={`py-2 px-4 rounded-md text-sm font-medium ${filterStatus === 'pending' ? 'bg-yellow-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                                >
                                    পেন্ডিং পোস্ট
                                </button>
                                <button
                                    onClick={() => setFilterStatus('approved')}
                                    className={`py-2 px-4 rounded-md text-sm font-medium ${filterStatus === 'approved' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                                >
                                    অনুমোদিত পোস্ট
                                </button>
                                <button
                                    onClick={() => setFilterStatus('rejected')}
                                    className={`py-2 px-4 rounded-md text-sm font-medium ${filterStatus === 'rejected' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                                >
                                    প্রত্যাখ্যাত পোস্ট
                                </button>
                            </div>

                            {loadingAllPosts ? (
                                <div className="text-center py-4">
                                    <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-2"></div>
                                    <p className="text-gray-600">সমস্ত পোস্ট লোড হচ্ছে...</p>
                                </div>
                            ) : allPosts.length > 0 ? (
                                <div className="space-y-4">
                                    {allPosts.map((post) => (
                                        <div key={post.id} className="bg-gray-50 rounded-lg p-4 shadow-sm border border-gray-200">
                                            {post.postType === 'job_sender' ? (
                                                <>
                                                    <h4 className="text-lg font-semibold text-blue-600">{post.jobTitle}</h4>
                                                    <p className="text-sm text-gray-600">শ্রমিক লাগবে: {post.numWorkersNeeded} জন</p>
                                                    <p className="text-sm text-gray-600">বিভাগ: {post.division}, জেলা: {post.district}</p>
                                                    <p className="text-sm text-gray-600">কাজের ধরণ: {post.jobCategory}</p>
                                                    {post.mobileNumber && <p className="text-sm text-gray-600">মোবাইল নম্বর: {post.mobileNumber}</p>} {/* Display mobile number */}
                                                    <p className="text-sm text-gray-700 mt-1">{post.description}</p>
                                                    {post.salary && <p className="text-green-600 text-sm">বেতন: {post.salary} টাকা</p>}
                                                </>
                                            ) : (
                                                <>
                                                    <h4 className="text-lg font-semibold text-purple-600">চাকরি খুঁজছি: {post.desiredJobTitle}</h4>
                                                    <p className="text-sm text-gray-600">কর্মী আছে: {post.numTeamMembers} জন</p>
                                                    <p className="text-sm text-gray-600">বিভাগ: {post.division}, জেলা: {post.district}</p>
                                                    <p className="text-sm text-gray-600">কাজের ধরণ: {post.jobCategory}</p>
                                                    {post.mobileNumber && <p className="text-sm text-gray-600">মোবাইল নম্বর: {post.mobileNumber}</p>} {/* Display mobile number */}
                                                    {post.expectedSalary && <p className="text-green-600 text-sm">প্রত্যাশিত বেতন: {post.expectedSalary} টাকা</p>}
                                                    <p className="text-sm text-gray-700 mt-1">{post.bioSummary}</p>
                                                </>
                                            )}
                                            <p className="text-xs text-gray-500 mt-3">পোস্ট করেছেন: {post.userName || post.postedBy}</p>
                                            {post.timestamp && (
                                                <p className="text-xs text-gray-500">
                                                    পোস্ট করা হয়েছে: {formatTimeAgo(post.timestamp)}
                                                </p>
                                            )}
                                            <p className="text-sm mt-2">স্ট্যাটাস: <span className={`font-semibold ${post.status === 'approved' ? 'text-green-500' : post.status === 'pending' ? 'text-yellow-500' : 'text-red-500'}`}>{post.status === 'pending' ? 'পেন্ডিং' : post.status === 'approved' ? 'অনুমোদিত' : 'প্রত্যাখ্যাত'}</span></p>

                                            <div className="flex flex-wrap justify-end gap-2 mt-3">
                                                {post.status === 'pending' && (
                                                    <>
                                                        <button
                                                            onClick={() => updatePostStatus(post.id, 'approved')}
                                                            className="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-150 ease-in-out"
                                                        >
                                                            অনুমোদন করুন
                                                        </button>
                                                        <button
                                                            onClick={() => updatePostStatus(post.id, 'rejected')}
                                                            className="bg-orange-500 hover:bg-orange-600 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-150 ease-in-out"
                                                        >
                                                            প্রত্যাখ্যান করুন
                                                        </button>
                                                    </>
                                                )}
                                                <button
                                                    onClick={() => handleDeleteClick(post.id)}
                                                    className="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md transition duration-150 ease-in-out"
                                                >
                                                    মুছে ফেলুন (অ্যাডমিন)
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-center text-gray-500">কোনো পোস্ট পাওয়া হয়নি।</p>
                            )}
                        </div> {/* End of scrollable content area */}
                    </div>
                </div>
            );
        }

        /**
         * FullPostModal component to display the full details of a single post.
         */
        function FullPostModal({ post, onClose, isLoggedIn }) { // Added isLoggedIn prop
            if (!post) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl transform transition-all duration-300 scale-100 opacity-100 my-8">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">পোস্টের বিস্তারিত</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1 transition duration-150 ease-in-out"
                                aria-label="ফর্ম বন্ধ করুন"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        {post.postType === 'job_sender' ? (
                            <>
                                <h3 className="text-xl font-bold text-blue-700 mb-2">{post.jobTitle}</h3>
                                <p className="text-gray-600 mb-1"><strong>শ্রমিক লাগবে:</strong> {post.numWorkersNeeded} জন</p>
                                <p className="text-gray-600 mb-1"><strong>বিভাগ:</strong> {post.division}</p>
                                <p className="text-gray-600 mb-1"><strong>জেলা:</strong> {post.district}</p>
                                <p className="text-gray-600 mb-1"><strong>কাজের ধরণ:</strong> {post.jobCategory}</p>
                                {post.mobileNumber && (
                                    <p className="text-gray-600 mb-1 flex items-center">
                                        <strong>মোবাইল নম্বর:</strong> {isLoggedIn ? (
                                            <a href={`tel:${post.mobileNumber}`} className="text-blue-600 hover:underline flex items-center ml-2">
                                                {post.mobileNumber}
                                                <svg className="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                </svg>
                                            </a>
                                        ) : 'লগইন করুন দেখতে'}
                                    </p>
                                )}
                                <p className="text-gray-700 mb-3 whitespace-pre-wrap">{post.description}</p>
                                {post.salary && <p className="text-green-600 font-semibold">বেতন: {post.salary} টাকা</p>}
                            </>
                        ) : (
                            <>
                                <h3 className="text-xl font-bold text-purple-700 mb-2">চাকরি খুঁজছি: {post.desiredJobTitle}</h3>
                                <p className="text-gray-600 mb-1"><strong>কর্মী আছে:</strong> {post.numTeamMembers} জন</p>
                                <p className="text-gray-600 mb-1"><strong>বিভাগ:</strong> {post.division}</p>
                                <p className="text-gray-600 mb-1"><strong>জেলা:</strong> {post.district}</p>
                                <p className="text-gray-600 mb-1"><strong>কাজের ধরণ:</strong> {post.jobCategory}</p>
                                {post.mobileNumber && (
                                    <p className="text-gray-600 mb-1 flex items-center">
                                        <strong>মোবাইল নম্বর:</strong> {isLoggedIn ? (
                                            <a href={`tel:${post.mobileNumber}`} className="text-blue-600 hover:underline flex items-center ml-2">
                                                {post.mobileNumber}
                                                <svg className="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                </svg>
                                            </a>
                                        ) : 'লগইন করুন দেখতে'}
                                    </p>
                                )}
                                {post.expectedSalary && <p className="text-green-600 font-semibold">প্রত্যাশিত বেতন: {post.expectedSalary} টাকা</p>}
                                <p className="text-gray-700 mt-3 whitespace-pre-wrap">{post.bioSummary}</p>
                            </>
                        )}
                        <p className="text-xs text-gray-500 mt-3">পোস্ট করেছেন: {post.userName || post.postedBy}</p>
                        {post.timestamp && (
                            <p className="text-xs text-gray-500">
                                পোস্ট করা হয়েছে: {formatTimeAgo(post.timestamp)}
                            </p>
                        )}
                        <p className="text-sm mt-2">স্ট্যাটাস: <span className={`font-semibold ${post.status === 'approved' ? 'text-green-500' : post.status === 'pending' ? 'text-yellow-500' : 'text-red-500'}`}>{post.status === 'pending' ? 'পেন্ডিং' : post.status === 'approved' ? 'অনুমোদিত' : 'প্রত্যাখ্যাত'}</span></p>
                    </div>
                </div>
            );
        }


        /**
         * Main App component for the Job Posting Board.
         * Handles Firebase initialization, authentication, data fetching, and pagination.
         */
        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null); // Stores the authenticated user's ID
            const [userFullName, setUserFullName] = useState(null); // New state for authenticated user's full name
            const [userRole, setUserRole] = useState('user'); // New state for user role, default to 'user'
            const [posts, setPosts] = useState([]); // Stores fetched job posts/seeker profiles
            const [loading, setLoading] = useState(true);
            // Initialize showAuthModal to false so it doesn't appear automatically
            const [showAuthModal, setShowAuthModal] = useState(false); // Controls visibility of the AuthForm modal
            const [error, setError] = useState(null);
            const [showPostForm, setShowPostForm] = useState(false); // Controls visibility of the PostJobForm modal
            const [showProfileModal, setShowProfileModal] = useState(false); // Controls visibility of the UserProfileModal
            const [showAdminPanel, setShowAdminPanel] = useState(false); // Controls visibility of the AdminPanelModal
            const [editingPost, setEditingPost] = useState(null); // Stores the post data when editing
            const [jobCategories, setJobCategories] = useState([]); // State for dynamic job categories

            // States for FullPostModal
            const [showFullPostModal, setShowFullPostModal] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);

            // Authentication modal states
            const [authMode, setAuthMode] = useState('login'); // 'login' or 'signup' mode for AuthForm

            // Pagination states
            const postsPerPage = 20; // Number of posts to display per page
            const [currentPage, setCurrentPage] = useState(1);
            // pageStartCursors stores the last document of each page to enable efficient pagination
            const [pageStartCursors, setPageStartCursors] = useState([null]); // null for the first page
            const [hasMore, setHasMore] = useState(false); // Indicates if there are more pages
            const [pageJumpInput, setPageJumpInput] = useState(''); // Input for direct page jump
            const [pageJumpError, setPageJumpError] = useState(null); // Error for page jump

            // New states for search and filters
            const [searchTerm, setSearchTerm] = useState('');
            const [filterDivision, setFilterDivision] = useState('');
            const [filterDistrict, setFilterDistrict] = useState('');
            const [filterJobCategory, setFilterJobCategory] = useState('');
            const [filterPostType, setFilterPostType] = useState('all'); // 'all', 'job_receiver', 'job_sender'
            const [showFilters, setShowFilters] = useState(false); // New state to control filter visibility

            // Initialize Firebase and set up authentication listener
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        // Use the globally available Firebase instances
                        const authInstance = window.authInstance;
                        const firestoreInstance = window.firestoreInstance;

                        setAuth(authInstance);
                        setDb(firestoreInstance);

                        // Listen for authentication state changes
                        window.onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setUserId(user.uid); // Set userId if a user is logged in
                                setShowAuthModal(false); // Close auth modal if user logs in

                                // Fetch user's full name and role from Firestore
                                const userDocRef = window.doc(firestoreInstance, `artifacts/${window.canvasAppId}/users/${user.uid}/profile/details`);
                                const userDocSnap = await window.getDoc(userDocRef);
                                if (userDocSnap.exists()) {
                                    const userData = userDocSnap.data();
                                    setUserFullName(userData.fullName);
                                    setUserRole(userData.role || 'user'); // Set role, default to 'user' if not defined
                                } else {
                                    // If user profile doesn't exist (e.g., old user or direct login without signup in this app)
                                    setUserFullName(user.email); // Fallback to email
                                    setUserRole('user'); // Default to user role
                                }

                            } else {
                                setUserId(null); // Clear userId if no user is logged in
                                setUserFullName(null); // Clear full name
                                setUserRole('user'); // Reset role to default
                            }
                            setLoading(false); // Loading is complete once auth state is determined
                        });

                    } catch (e) {
                        console.error("Error initializing Firebase or authenticating:", e);
                        setError("Firebase শুরু করতে বা প্রমাণীকরণ করতে সমস্যা হয়েছে।");
                        setLoading(false);
                    }
                };

                initFirebase();
            }, []); // Empty dependency array ensures this effect runs only once on mount

            // Fetch posts from Firestore with pagination and filters in real-time
            useEffect(() => {
                // Only fetch if db is available (posts are visible to everyone)
                if (!db) {
                    setPosts([]); // Clear posts if db is not available
                    return;
                }

                // Reference to the 'posts' collection in Firestore
                // Data is stored publicly under artifacts/{canvasAppId}/public/data/posts
                const postsCollectionRef = window.collection(db, `artifacts/${window.canvasAppId}/public/data/posts`);

                // Get the starting document for the current page from pageStartCursors
                const startDoc = pageStartCursors[currentPage - 1];

                // Base query: approved posts, ordered by timestamp
                let q = window.query(
                    postsCollectionRef,
                    window.where('status', '==', 'approved'),
                    window.orderBy('timestamp', 'desc')
                );

                // Apply pagination limit and startAfter
                if (startDoc) {
                    q = window.query(q, window.startAfter(startDoc), window.limit(postsPerPage + 1));
                } else {
                    q = window.query(q, window.limit(postsPerPage + 1));
                }

                // Set up a real-time listener using onSnapshot
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    let fetchedPosts = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Apply client-side filters
                    let filteredClientSide = fetchedPosts.filter(post => {
                        // Filter by postType
                        if (filterPostType !== 'all' && post.postType !== filterPostType) {
                            return false;
                        }
                        // Filter by division
                        if (filterDivision && post.division !== filterDivision) {
                            return false;
                        }
                        // Filter by district
                        if (filterDistrict && post.district !== filterDistrict) {
                            return false;
                        }
                        // Filter by jobCategory
                        if (filterJobCategory && post.jobCategory !== filterJobCategory) {
                            return false;
                        }
                        // Filter by search term (title or description/bioSummary)
                        if (searchTerm) {
                            const lowerCaseSearchTerm = searchTerm.toLowerCase();
                            const title = post.postType === 'job_sender' ? post.jobTitle : post.desiredJobTitle;
                            const description = post.postType === 'job_sender' ? post.description : post.bioSummary;
                            if (!((title && title.toLowerCase().includes(lowerCaseSearchTerm)) ||
                                  (description && description.toLowerCase().includes(lowerCaseSearchTerm)))) {
                                return false;
                            }
                        }
                        return true;
                    });

                    // Update hasMore based on the original fetchedPosts length (before client-side filtering)
                    // This is important because hasMore should reflect if there are more *database* pages,
                    // not just more client-side filtered items.
                    setHasMore(fetchedPosts.length > postsPerPage);

                    // Set the posts to the client-side filtered results
                    setPosts(filteredClientSide.slice(0, postsPerPage)); // Still show only `postsPerPage` after client-side filtering

                    // If there are more posts from the database and we haven't stored the cursor for the next page yet,
                    // store the last document of the original fetched batch as the start cursor for the next page.
                    if (fetchedPosts.length > postsPerPage && pageStartCursors.length <= currentPage) {
                        const nextStartDoc = snapshot.docs[postsPerPage - 1];
                        setPageStartCursors(prev => {
                            const newCursors = [...prev];
                            newCursors[currentPage] = nextStartDoc;
                            return newCursors;
                        });
                    }
                }, (e) => {
                    console.error("Error fetching posts with pagination:", e);
                    setError("পোস্টের তালিকা লোড করতে সমস্যা হয়েছে।");
                });

                // Clean up the listener when the component unmounts or dependencies change
                return () => unsubscribe();
            }, [db, currentPage, pageStartCursors.length, filterDivision, filterDistrict, filterJobCategory, filterPostType, searchTerm]); // Added filter dependencies

            // Reset pagination when filters change
            useEffect(() => {
                setCurrentPage(1);
                setPageStartCursors([null]);
            }, [filterDivision, filterDistrict, filterJobCategory, filterPostType, searchTerm]);


            // Fetch job categories from Firestore
            useEffect(() => {
                if (!db) return;

                const categoriesCollectionRef = window.collection(db, `artifacts/${window.canvasAppId}/public/data/jobCategories`);
                const q = window.query(categoriesCollectionRef, window.orderBy('name', 'asc'));

                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const fetchedCategories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setJobCategories(fetchedCategories);
                }, (e) => {
                    console.error("Error fetching job categories:", e);
                    setError("কাজের ধরণ লোড করতে সমস্যা হয়েছে।");
                });

                return () => unsubscribe();
            }, [db]);


            /**
             * Function to add a new post (job or job seeker profile) to Firestore.
             * Uses serverTimestamp for accurate server-side timestamping.
             */
            const addJob = async (postData) => {
                if (!db || !userId || !userFullName) { // Ensure user and their name are available
                    setError("পোস্ট করার জন্য লগইন করুন এবং আপনার নাম উপলব্ধ আছে কিনা নিশ্চিত করুন।");
                    return;
                }
                try {
                    await window.addDoc(window.collection(db, `artifacts/${window.canvasAppId}/public/data/posts`), {
                        ...postData,
                        postedBy: userId,
                        userName: userFullName, // Store the full name with the post
                        timestamp: window.serverTimestamp(), // Use serverTimestamp for accurate time
                        status: 'pending' // New posts are always pending by default
                    });
                    console.log("Post added successfully!");
                    setShowPostForm(false); // Close the form after successful submission
                    setCurrentPage(1); // Go back to the first page to see the new post
                    setPageStartCursors([null]); // Reset pagination cursors
                } catch (e) {
                    console.error("Error adding post:", e);
                    setError("পোস্ট করতে সমস্যা হয়েছে।");
                    throw e; // Re-throw to allow PostJobForm to catch and display specific error
                }
            };

            /**
             * Function to update an existing post in Firestore.
             */
            const updateJob = async (postId, updatedData) => {
                if (!db || !userId) {
                    setError("পোস্ট আপডেট করার জন্য লগইন করুন।");
                    return;
                }
                try {
                    const postRef = window.doc(db, `artifacts/${window.canvasAppId}/public/data/posts`, postId);
                    // Ensure only the owner can update (client-side check, security rules also needed)
                    const postSnap = await window.getDoc(postRef);
                    if (postSnap.exists() && postSnap.data().postedBy === userId) {
                        await window.updateDoc(postRef, {
                            ...updatedData,
                            timestamp: window.serverTimestamp(), // Update timestamp on edit
                            status: 'pending' // Set status to pending after edit
                        });
                        console.log("Post updated successfully!");
                        setEditingPost(null); // Clear editing state
                        setShowPostForm(false); // Close the form
                    } else {
                        setError("আপনি এই পোস্টটি সম্পাদনা করার অনুমতিপ্রাপ্ত নন।");
                    }
                } catch (e) {
                    console.error("Error updating post:", e);
                    setError("পোস্ট আপডেট করতে সমস্যা হয়েছে।");
                    throw e;
                }
            };

            /**
             * Function to delete a post from Firestore.
             */
            const deletePost = async (postId) => {
                if (!db || !userId) {
                    setError("পোস্ট মুছে ফেলার জন্য লগইন করুন।");
                    return;
                }
                try {
                    const postRef = window.doc(db, `artifacts/${window.canvasAppId}/public/data/posts`, postId);
                    const postSnap = await window.getDoc(postRef);

                    // Check if the user is an admin OR the owner of the post
                    if (userRole === 'admin' || (postSnap.exists() && postSnap.data().postedBy === userId)) {
                        await window.deleteDoc(postRef);
                        console.log("Post deleted successfully!");
                    } else {
                        setError("আপনি এই পোস্টটি মুছে ফেলার অনুমতিপ্রাপ্ত নন।");
                    }
                } catch (e) {
                    console.error("Error deleting post:", e);
                    setError("পোস্ট মুছে ফেলতে সমস্যা হয়েছে।");
                    throw e;
                }
            };


            // Handles user logout
            const handleLogout = async () => {
                if (auth) {
                    try {
                        await window.signOut(auth);
                        setUserId(null); // Clear userId on logout
                        setUserFullName(null); // Clear full name on logout
                        setUserRole('user'); // Reset role
                        setPosts([]); // Clear posts on logout (optional, can be kept if desired)
                        setCurrentPage(1); // Reset pagination
                        setPageStartCursors([null]);
                        setShowProfileModal(false); // Close profile modal on logout
                        setShowAdminPanel(false); // Close admin panel on logout
                        setEditingPost(null); // Clear any editing state
                        setAuthMode('login'); // Default to login mode
                        console.log("Logged out successfully!");
                    } catch (e) {
                        console.error("Error logging out:", e);
                        setError("লগআউট করতে সমস্যা হয়েছে।");
                    }
                }
            };

            // Callback for successful authentication (login or signup)
            const handleAuthSuccess = async (user, name) => {
                setUserId(user.uid);
                setShowAuthModal(false);

                // If it's a new signup with a name, store it in Firestore
                if (name) {
                    try {
                        const userDocRef = window.doc(db, `artifacts/${window.canvasAppId}/users/${user.uid}/profile/details`);
                        // Set role to 'user' for new signups by default
                        await window.setDoc(userDocRef, { fullName: name, email: user.email, role: 'user' }, { merge: true });
                        setUserFullName(name);
                        setUserRole('user');
                        console.log("User profile created/updated in Firestore.");
                    } catch (e) {
                        console.error("Error saving user profile:", e);
                        setError("ব্যবহারকারীর প্রোফাইল সংরক্ষণ করতে সমস্যা হয়েছে।");
                    }
                } else {
                    // For login, fetch the name and role if they exist
                    try {
                        const userDocRef = window.doc(db, `artifacts/${window.canvasAppId}/users/${user.uid}/profile/details`);
                        const userDocSnap = await window.getDoc(userDocRef);
                        if (userDocSnap.exists()) {
                            const userData = userDocSnap.data();
                            setUserFullName(userData.fullName);
                            setUserRole(userData.role || 'user'); // Fallback to 'user'
                        } else {
                            setUserFullName(user.email); // Fallback to email
                            setUserRole('user'); // Default to user role
                        }
                    } catch (e) {
                        console.error("Error fetching user profile on login:", e);
                        setUserFullName(user.email); // Fallback to email on error
                        setUserRole('user'); // Default to user role on error
                    }
                }
            };

            // Function to handle editing a post from the profile modal
            const handleEditPostClick = (post) => {
                setEditingPost(post);
                setShowPostForm(true); // Open the post form in edit mode
                setShowProfileModal(false); // Close the profile modal
            };

            // Function to handle opening the full post modal
            const handlePostClick = (post) => {
                setSelectedPost(post);
                setShowFullPostModal(true);
            };


            // Pagination navigation functions
            const goToNextPage = () => {
                if (hasMore) {
                    setCurrentPage(prev => prev + 1);
                }
            };

            const goToPreviousPage = () => {
                if (currentPage > 1) {
                    setCurrentPage(prev => prev - 1);
                }
            };

            const goToFirstPage = () => {
                setCurrentPage(1);
                setPageStartCursors([null]); // Reset cursors to start from the beginning
            };

            // Handles direct page jumps
            const handlePageJump = () => {
                const targetPage = parseInt(pageJumpInput, 10);
                if (isNaN(targetPage) || targetPage < 1) {
                    setPageJumpError("অনুগ্রহ করে একটি বৈধ পৃষ্ঠা নম্বর লিখুন।");
                    return;
                }
                setPageJumpError(null); // Clear previous page jump errors

                // Firestore pagination with startAfter works sequentially.
                // We can only jump to a page if we have already visited it (and thus stored its start cursor)
                // or if it's the first page.
                if (targetPage === 1 || (targetPage - 1 < pageStartCursors.length && pageStartCursors[targetPage - 1])) {
                    setCurrentPage(targetPage);
                } else {
                    setPageJumpError("এই পৃষ্ঠায় সরাসরি যাওয়া সম্ভব নয়। অনুগ্রহ করে 'পরবর্তী' বাটন ব্যবহার করে পর্যায়ক্রমে যান।");
                }
            };

            // Get districts based on the selected filter division
            const districtsForFilterDivision = filterDivision ? DIVISIONS_DATA[filterDivision] : [];


            // Display loading state
            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
                            <p className="text-lg text-gray-700">লোড হচ্ছে...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-900">
                    {/* Header */}
                    <header className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 shadow-lg">
                        <div className="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                            <h1 className="text-3xl font-extrabold mb-2 sm:mb-0">শ্রমিক বাজার</h1>
                            <div className="flex items-center space-x-4">
                                {/* Admin Panel Icon (visible only to admin user) */}
                                {userRole === 'admin' && ( // Check userRole instead of hardcoded ID
                                    <button
                                        onClick={() => setShowAdminPanel(true)}
                                        className="text-white hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1 transition duration-150 ease-in-out"
                                        title="অ্যাডমিন প্যানেল"
                                    >
                                        {/* Simple gear icon for admin panel */}
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.307 2.572-1.065z"></path>
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                )}

                                {userId ? (
                                    <>
                                        {/* Post Button in Header */}
                                        <button
                                            onClick={() => {
                                                setEditingPost(null); // Ensure no post is being edited when opening for new post
                                                setShowPostForm(true);
                                            }}
                                            className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-300 text-sm"
                                        >
                                            পোস্ট করুন
                                        </button>

                                        {/* User Profile Icon */}
                                        <button
                                            onClick={() => setShowProfileModal(true)}
                                            className="text-white hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-full p-1 transition duration-150 ease-in-out"
                                            title="আমার প্রোফাইল দেখুন"
                                        >
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                            <span className="sr-only">আমার প্রোফাইল</span>
                                        </button>

                                        {/* Logout Icon */}
                                        <button
                                            onClick={handleLogout}
                                            className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center"
                                            title="লগআউট"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                            </svg>
                                            <span className="sr-only">লগআউট</span> {/* Screen reader text */}
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        {/* Separate Login and Signup buttons */}
                                        <button
                                            onClick={() => { setShowAuthModal(true); setAuthMode('login'); }}
                                            className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                                        >
                                            লগইন
                                        </button>
                                        <button
                                            onClick={() => { setShowAuthModal(true); setAuthMode('signup'); }}
                                            className="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                                        >
                                            সাইনআপ
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="container mx-auto p-4 mt-8">
                        {/* Error Display */}
                        {error && (
                            <div className="bg-red-100 text-red-700 p-4 rounded-lg mb-6 shadow-sm">
                                <p className="font-semibold">ত্রুটি:</p>
                                <p>{error}</p>
                            </div>
                        )}

                        {/* Search and Filter Section */}
                        <section className="bg-white rounded-xl shadow-lg p-6 mb-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">পোস্ট খুঁজুন</h2>
                            <div className="flex items-center gap-2 mb-4">
                                {/* Search Input with Icon */}
                                <div className="relative flex-grow">
                                    <input
                                        type="text"
                                        id="searchTerm"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        placeholder="শিরোনাম বা বর্ণনা দিয়ে সার্চ করুন..."
                                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    />
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg className="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>

                                {/* Filter Icon Button */}
                                <button
                                    onClick={() => setShowFilters(!showFilters)}
                                    className="p-2 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                                    title="ফিল্টার অপশন"
                                >
                                    <svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                    </svg>
                                </button>
                            </div>

                            {/* Filter Options (Conditional Rendering) */}
                            {showFilters && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 transition-all duration-300 ease-in-out">
                                    {/* Post Type Filter */}
                                    <div>
                                        <label htmlFor="filterPostType" className="block text-sm font-medium text-gray-700 mb-1">পোস্টের ধরণ</label>
                                        <select
                                            id="filterPostType"
                                            value={filterPostType}
                                            onChange={(e) => setFilterPostType(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        >
                                            <option value="all">সকল পোস্ট</option>
                                            <option value="job_receiver">শ্রমিক</option>
                                            <option value="job_sender">মালিক</option>
                                        </select>
                                    </div>

                                    {/* Division Filter */}
                                    <div>
                                        <label htmlFor="filterDivision" className="block text-sm font-medium text-gray-700 mb-1">বিভাগ</label>
                                        <select
                                            id="filterDivision"
                                            value={filterDivision}
                                            onChange={(e) => {
                                                setFilterDivision(e.target.value);
                                                setFilterDistrict(''); // Reset district when division changes
                                            }}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        >
                                            <option value="">সকল বিভাগ</option>
                                            {Object.keys(DIVISIONS_DATA).map((division) => (
                                                <option key={division} value={division}>{division}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* District Filter */}
                                    <div>
                                        <label htmlFor="filterDistrict" className="block text-sm font-medium text-gray-700 mb-1">জেলা</label>
                                        <select
                                            id="filterDistrict"
                                            value={filterDistrict}
                                            onChange={(e) => setFilterDistrict(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            disabled={!filterDivision} // Disable until division is selected
                                        >
                                            <option value="">সকল জেলা</option>
                                            {districtsForFilterDivision.map((district) => (
                                                <option key={district} value={district}>{district}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Job Category Filter */}
                                    <div>
                                        <label htmlFor="filterJobCategory" className="block text-sm font-medium text-gray-700 mb-1">কাজের ধরণ</label>
                                        <select
                                            id="filterJobCategory"
                                            value={filterJobCategory}
                                            onChange={(e) => setFilterJobCategory(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        >
                                            <option value="">সকল ধরণ</option>
                                            {jobCategories.map((category) => (
                                                <option key={category.id} value={category.name}>{category.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* Job Listings */}
                        <section className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {posts.length > 0 ? (
                                posts.map((post) => (
                                    <div
                                        key={post.id}
                                        className={`rounded-xl shadow-lg p-6 border transition-shadow duration-300 cursor-pointer 
                                            ${post.postType === 'job_sender' ? 'bg-blue-50 border-blue-200 hover:shadow-blue-200' : 'bg-purple-50 border-purple-200 hover:shadow-purple-200'}`}
                                        onClick={() => handlePostClick(post)} // Make the entire card clickable
                                    >
                                        {post.postType === 'job_sender' ? (
                                            <>
                                                <h3 className="text-xl font-bold text-blue-700 mb-2">{post.jobTitle}</h3>
                                                {/* Display Number of Workers Needed */}
                                                <p className="text-gray-600 mb-1"><strong>শ্রমিক লাগবে:</strong> {post.numWorkersNeeded} জন</p>
                                                {/* Removed Division from here */}
                                                <p className="text-gray-600 mb-1"><strong>জেলা:</strong> {post.district}</p>
                                                <p className="text-600 mb-1"><strong>কাজের ধরণ:</strong> {post.jobCategory}</p>
                                                <p className="text-gray-700 mb-3 truncate-1-line">{post.description}</p> {/* Truncate here */}
                                                {post.salary && <p className="text-green-600 font-semibold">বেতন: {post.salary} টাকা</p>}
                                            </>
                                        ) : (
                                            <>
                                                {/* MODIFICATION START: Removed "চাকরি খুঁজছি: " from the title */}
                                                <h3 className="text-xl font-bold text-purple-700 mb-2">{post.desiredJobTitle}</h3>
                                                {/* MODIFICATION END */}

                                                {/* Display Number of Team Members */}
                                                <p className="text-gray-600 mb-1"><strong>কর্মী আছে:</strong> {post.numTeamMembers} জন</p>

                                                {/* MODIFICATION START: Changed "বিভাগ" to "জেলা" */}
                                                <p className="text-gray-600 mb-1"><strong>জেলা:</strong> {post.district}</p>
                                                {/* MODIFICATION END */}
                                                
                                                <p className="text-gray-600 mb-1"><strong>কাজের ধরণ:</strong> {post.jobCategory}</p>
                                                {post.expectedSalary && <p className="text-green-600 font-semibold">প্রত্যাশিত বেতন: {post.expectedSalary} টাকা</p>}
                                                <p className="text-gray-700 mt-3 truncate-1-line">{post.bioSummary}</p> {/* Truncate here */}
                                            </>
                                        )}
                                        <p className="text-xs text-gray-500 mt-3">পোস্ট করেছেন: {post.userName || post.postedBy}</p>
                                        {post.timestamp && (
                                            <p className="text-xs text-gray-500">
                                                পোস্ট করা হয়েছে: {formatTimeAgo(post.timestamp)}
                                            </p>
                                        )}
                                    </div>
                                ))
                            ) : (
                                <div className="col-span-full text-center py-10 text-gray-500 text-lg">
                                    কোনো পোস্ট পাওয়া যায়নি। নতুন পোস্ট যোগ করুন!
                                </div>
                            )}
                        </section>

                        {/* Pagination Controls */}
                        {/* Pagination controls are now visible to everyone */}
                        <div className="flex flex-col items-center mt-8 space-y-4">
                            {/* Previous, Current Page, Next on one line */}
                            <div className="flex flex-wrap justify-center items-center gap-4">
                                <button
                                    onClick={goToPreviousPage}
                                    disabled={currentPage === 1}
                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    পূর্ববর্তী
                                </button>
                                <span className="text-lg font-semibold text-gray-700">
                                    পৃষ্ঠা {currentPage}
                                </span>
                                <button
                                    onClick={goToNextPage}
                                    disabled={!hasMore}
                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    পরবর্তী
                                </button>
                            </div>

                            {/* First Page, Page #, Go on the second line - now smaller and more compact */}
                            <div className="flex flex-wrap justify-center items-center gap-2 mt-2"> {/* Reduced gap and margin-top */}
                                <button
                                    onClick={goToFirstPage}
                                    disabled={currentPage === 1}
                                    className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-2 rounded-md shadow-sm text-xs transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    প্রথম পৃষ্ঠা
                                </button>
                                <div className="flex items-center space-x-1"> {/* Reduced space-x */}
                                    <input
                                        type="number"
                                        value={pageJumpInput}
                                        onChange={(e) => setPageJumpInput(e.target.value)}
                                        placeholder="পৃষ্ঠা #"
                                        className="w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-xs" /* Reduced width, padding, and font size */
                                    />
                                    <button
                                        onClick={handlePageJump}
                                        className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded-md shadow-sm text-xs transition duration-300 ease-in-out" /* Reduced padding and font size */
                                    >
                                        যাও
                                    </button>
                                </div>
                            </div>
                            {pageJumpError && (
                                <p className="text-red-500 text-sm mt-2">{pageJumpError}</p>
                            )}
                        </div>
                    </main>

                    {/* Auth Modal */}
                    {showAuthModal && (
                        <AuthForm
                            mode={authMode}
                            onClose={() => setShowAuthModal(false)}
                            onToggleMode={() => setAuthMode(prevMode => (prevMode === 'login' ? 'signup' : 'login'))}
                            authInstance={auth}
                            onAuthSuccess={handleAuthSuccess}
                        />
                    )}

                    {/* Post Job Form Modal */}
                    {showPostForm && (
                        <PostJobForm
                            onClose={() => {
                                setShowPostForm(false);
                                setEditingPost(null);
                            }}
                            onAddJob={addJob}
                            initialData={editingPost}
                            onUpdateJob={updateJob}
                            jobCategories={jobCategories}
                        />
                    )}

                    {/* User Profile Modal */}
                    {showProfileModal && (
                        <UserProfileModal
                            onClose={() => setShowProfileModal(false)}
                            userId={userId}
                            userFullName={userFullName}
                            db={db}
                            onEditPost={handleEditPostClick}
                            onDeletePost={deletePost}
                        />
                    )}

                    {/* Admin Panel Modal */}
                    {showAdminPanel && (
                        <AdminPanelModal
                            onClose={() => setShowAdminPanel(false)}
                            db={db}
                            onDeletePost={deletePost}
                            isAdmin={userRole === 'admin'}
                        />
                    )}

                    {/* Full Post Details Modal */}
                    {showFullPostModal && (
                        <FullPostModal
                            post={selectedPost}
                            onClose={() => {
                                setShowFullPostModal(false);
                                setSelectedPost(null);
                            }}
                            isLoggedIn={!!userId} // Pass login status to FullPostModal
                        />
                    )}
                </div>
            );
        }

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
